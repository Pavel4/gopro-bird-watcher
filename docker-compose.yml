services:
  nginx-rtmp:
    image: tiangolo/nginx-rtmp
    container_name: gopro-rtmp-server
    ports:
      - "1935:1935"   # RTMP порт для приёма потока от GoPro
      - "8080:80"     # HTTP порт для статистики
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./recordings:/recordings
    restart: unless-stopped

  # Единый контейнер для детектора движения и разработки
  # Запуск: docker-compose up -d
  # Подключение: docker exec -it gopro-detector bash
  # Внутри можно запускать: python detector/motion_detector.py
  detector:
    build: ./detector
    container_name: gopro-detector
    volumes:
      - .:/app
    environment:
      - RTMP_URL=rtmp://nginx-rtmp/live
      - OUTPUT_DIR=/app/recordings
      - LOG_FILE=/app/logs/motion_detector.log
      - TZ=Europe/Moscow
      - BUFFER_SECONDS=5
      - POST_MOTION_SECONDS=5
      - MIN_CONTOUR_AREA=500
      - MIN_MOTION_FRAMES=3
      - MOTION_AREA_PERCENT=0.5
      - CONTROL_FILE=/app/control/command
      # ROI (Region of Interest) - область кормушки
      # Значения берутся из config.env или переопределяются здесь
      - ROI_ENABLED=${ROI_ENABLED:-false}
      - ROI_X=${ROI_X:-0}
      - ROI_Y=${ROI_Y:-0}
      - ROI_WIDTH=${ROI_WIDTH:-0}
      - ROI_HEIGHT=${ROI_HEIGHT:-0}
      # X11 для интерактивного выбора ROI (опционально)
      - DISPLAY=${DISPLAY:-:0}
    working_dir: /app
    stdin_open: true
    tty: true
    depends_on:
      - nginx-rtmp
    command: sleep infinity
    restart: unless-stopped

  # Опционально: веб-плеер для просмотра в браузере
  # web-player:
  #   image: nginx:alpine
  #   ports:
  #     - "8081:80"
  #   volumes:
  #     - ./web:/usr/share/nginx/html:ro
  #   depends_on:
  #     - nginx-rtmp
