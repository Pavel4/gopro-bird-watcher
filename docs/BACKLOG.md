# Backlog

Известные проблемы, ограничения и планы на будущее.

---

## Известные проблемы

### [BUG] macOS: черные интервалы 5-10 секунд в начале видео

**Платформа:** macOS (AVFoundation)
**Описание:** В начале записанного видео могут появляться черные кадры длительностью 5-10 секунд.
**Причина:** AVFoundation на macOS не поддерживает сегментацию в реальном времени, используется режим прямой записи с вырезкой по времени (`-ss` / `-t`). Смещение при вырезке может захватывать интервал до начала реального видеопотока.
**Воспроизведение:** Запустить детектор, вызвать движение через 10-15 сек после старта. Открыть сохраненное видео.
**Приоритет:** Средний

### [BUG] macOS: иногда битые фрагменты внутри видео

**Платформа:** macOS (AVFoundation)
**Описание:** Внутри видео могут встречаться короткие артефакты (глитчи, замирания).
**Причина:** Прямая запись через FFmpeg + AVFoundation иногда дает сбои при высокой нагрузке на CPU.
**Приоритет:** Низкий

### [LIMITATION] macOS: нет pre-buffer (буфера до начала движения)

**Платформа:** macOS (AVFoundation)
**Описание:** На macOS запись начинается с момента детекции движения, а не за N секунд до него.
**Причина:** AVFoundation не поддерживает FFmpeg сегментацию (`-f segment`). На Linux/Raspberry Pi сегментация работает и pre-buffer доступен.
**Обходной путь:** Нет. Ограничение платформы.
**Приоритет:** Низкий (на целевой платформе Raspberry Pi работает корректно)

### [IMPROVEMENT] FFmpeg: улучшить логику перезапуска

**Описание:** FFmpeg может зависнуть после 20 неудачных попыток перезапуска. Нет механизма уведомления пользователя.
**Решение:** Добавить Telegram-уведомление при критических ошибках FFmpeg и более умную стратегию перезапуска (exponential backoff).
**Приоритет:** Средний

---

## Планируемые фичи

### [FEATURE] ML-модель для распознавания видов птиц

Интегрировать модель машинного обучения для автоматической классификации видов птиц на видео. Добавить название вида в caption Telegram-уведомления.

### [FEATURE] Веб-интерфейс для просмотра записей

Простой веб-интерфейс (Flask/FastAPI) для:
- Просмотра последних записей
- Просмотра статистики
- Управления детектором (вкл/выкл, настройки)

### [FEATURE] Статистика посещений кормушки

Сбор и визуализация данных:
- Количество визитов в день/неделю
- Распределение по времени суток
- Средняя длительность визита
- Экспорт в CSV

### [FEATURE] ~~Интерактивный выбор ROI через GUI~~

~~Добавить графический интерфейс для выбора области интереса (Region of Interest) на кадре с камеры, вместо ручного указания координат в конфиге.~~

**DONE:** Реализовано в `select_roi.py --usb auto`.
Документация: [docs/ROI_SETUP.md](ROI_SETUP.md)

### [FEATURE] Мониторинг состояния камеры

- Уровень заряда батареи GoPro
- Температура камеры
- Параметры текущего потока
- Telegram-уведомления при проблемах с камерой

---

## Идеи для развития проекта

### Высокий приоритет (ближайшее время)

#### [FEATURE] Расписание активности

Включение/выключение детекции по расписанию
(рассвет — закат). Варианты реализации:
- Библиотека `astral` — автоматический расчет
  восхода/заката по GPS координатам
- Cron-задачи через `schedule` или системный cron
- Параметры конфигурации: `SCHEDULE_ENABLED`,
  `SCHEDULE_START`, `SCHEDULE_STOP`, `SCHEDULE_LAT`,
  `SCHEDULE_LON`

#### [FEATURE] Оверлей с датой/временем на видео

Наложение текстовой информации на записанные видео:
- Дата и время записи
- Номер события / длительность
- Реализация через FFmpeg фильтр `drawtext`
- Параметр конфигурации: `VIDEO_OVERLAY_ENABLED`

#### [FEATURE] Улучшенные Telegram-уведомления

Расширить функциональность Telegram-бота:
- Отправка скриншота (фото кадра) вместе с видео
- Inline-кнопки управления
  (вкл/выкл детекцию, статус, скриншот)
- Команда `/screenshot` — текущий кадр с камеры
- Команда `/roi` — кадр с отрисованной областью ROI
- Команда `/settings` — просмотр/изменение настроек

### Средний приоритет

#### [FEATURE] ML-распознавание видов птиц

Автоматическая классификация вида птицы на видео:
- **YOLOv8 Nano** — детекция птицы в кадре (lightweight)
- **MobileNetV3** — классификация вида
- Готовый проект-референс:
  [yolowing](https://github.com/Nylio-prog/yolowing)
- Добавление названия вида в caption Telegram-сообщения
- Оптимизация для Raspberry Pi через ONNX Runtime
  или TensorFlow Lite

#### [FEATURE] BirdNET-PI — распознавание по звуку

Интеграция с [BirdNET](https://birdnetpi.com/) для
определения вида птицы по звуку:
- Микрофон GoPro или внешний USB-микрофон
- BirdNET ML-модель (работает на Raspberry Pi)
- Корреляция визуальной и аудио-детекции
- Уведомление с видом птицы (аудио + видео)

#### [FEATURE] Веб-интерфейс

Простой веб-интерфейс (Flask/FastAPI):
- Просмотр последних записей (видео-галерея)
- Статистика посещений (графики)
- Управление детектором (вкл/выкл, настройки)
- Live-превью с камеры (MJPEG стрим)
- Мобильная адаптация (responsive)

#### [FEATURE] Статистика посещений кормушки

Детальный сбор и визуализация данных:
- Количество визитов в день/неделю/месяц
- Распределение по времени суток (heatmap)
- Средняя длительность визита
- Экспорт в CSV для анализа
- Графики через matplotlib или Plotly
- Telegram-команда `/stats` — сводка за день

### Низкий приоритет (будущее)

#### [FEATURE] Home Assistant интеграция

Интеграция с Home Assistant через MQTT:
- Сенсоры: статус камеры, кол-во визитов сегодня,
  последнее видео, температура
- Автоматизации: включение подсветки при движении,
  уведомления через HA
- MQTT-брокер (Mosquitto)
- Параметры: `MQTT_BROKER`, `MQTT_TOPIC`

#### [FEATURE] Таймлапс

Автоматическая генерация timelapse-видео:
- Из записанных видео за день/неделю
- Настраиваемая скорость (x10, x50, x100)
- Ежедневная генерация по cron
- Отправка в Telegram
- FFmpeg: `setpts=0.1*PTS` для ускорения

#### [FEATURE] Ночной режим

Адаптация для работы ночью:
- ИК-подсветка (внешний модуль для Raspberry Pi)
- Автопереключение параметров детекции
  (чувствительность, пороги)
- Режим grayscale для ИК-камеры
- Расписание день/ночь (связь с фичей "Расписание")

#### [FEATURE] Мульти-камера

Поддержка нескольких камер/кормушек:
- Несколько экземпляров детектора
- Разные конфиги для каждой камеры
- Единый Telegram-бот для всех камер
- Docker Compose с несколькими сервисами

#### [FEATURE] Оповещения об ошибках

Telegram-уведомления при критических событиях:
- Падение FFmpeg (N неудачных перезапусков)
- Отключение камеры (потеря USB-соединения)
- Заполнение диска (< X GB свободного места)
- Долгое отсутствие движения
  (камера могла сдвинуться или упасть)

#### [FEATURE] Live-стриминг

Стрим с камеры для просмотра в реальном времени:
- RTSP сервер (ffmpeg → rtsp-simple-server)
- HLS стрим (для просмотра в браузере)
- MJPEG стрим (легковесный, для веб-интерфейса)

#### [FEATURE] Метеоданные на видео

Наложение погодных данных на записанные видео:
- API: OpenWeatherMap (бесплатно до 1000 req/day)
- Температура, влажность, давление, ветер
- FFmpeg `drawtext` оверлей
- Корреляция посещений с погодой в статистике
