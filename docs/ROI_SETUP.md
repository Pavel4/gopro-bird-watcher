# Настройка ROI (Region of Interest)

ROI — прямоугольная область кадра, в которой детектируется движение.
Если ROI включён:
- Движение анализируется **только** внутри этой области
- Сохранённое видео **обрезается** до этой области

Это полезно когда камера видит большую территорию,
а кормушка занимает только часть кадра.

## Как это работает

```
+----------------------------------+
|                                  |
|    +------------------+          |
|    |  ROI (кормушка)  |          |
|    |  Движение здесь  |          |
|    |  детектируется    |          |
|    +------------------+          |
|                                  |
|   Остальная часть игнорируется   |
+----------------------------------+
```

Параметры ROI:

| Параметр    | Описание                         |
|-------------|----------------------------------|
| ROI_ENABLED | true/false — включить ROI        |
| ROI_X       | X-координата левого верхнего угла|
| ROI_Y       | Y-координата левого верхнего угла|
| ROI_WIDTH   | Ширина области в пикселях        |
| ROI_HEIGHT  | Высота области в пикселях        |

## Способ 1: Интерактивный выбор (рекомендуется)

Скрипт захватывает кадр с камеры и открывает окно,
где можно мышкой нарисовать прямоугольник.

### Нативный режим (macOS / Linux)

```bash
# GoPro по USB (автоопределение)
./scripts/select-roi.sh

# Указать индекс камеры
./scripts/select-roi.sh --usb 0

# Или напрямую через Python
python detector/select_roi.py --usb auto
```

### Docker

```bash
./scripts/select-roi.sh --docker
```

### Управление в окне

- **Мышь** — нарисовать прямоугольник (зажать ЛКМ и тянуть)
- **ENTER** — подтвердить выбор
- **R** — сбросить и нарисовать заново
- **Q / ESC** — отмена

После подтверждения координаты автоматически сохраняются
в конфигурационный файл (config.macos.env / config.pi.env / config.env).

## Способ 2: Через скриншот (без GUI)

Если нет графического дисплея (headless-сервер, SSH),
можно захватить кадр и определить координаты вручную.

### Шаг 1. Захватить кадр с камеры

**macOS (USB):**

```bash
# Через select_roi.py (сохраняет кадр без GUI)
python detector/select_roi.py --usb auto \
    --save-frame frame.jpg --no-save

# Или через FFmpeg напрямую
ffmpeg -f avfoundation -framerate 30 \
    -video_size 1920x1080 -i "0" \
    -frames:v 1 frame.jpg
```

**Linux / Raspberry Pi:**

```bash
ffmpeg -f v4l2 -video_size 1920x1080 \
    -i /dev/video0 -frames:v 1 frame.jpg
```

### Шаг 2. Определить координаты

Откройте `frame.jpg` в любом графическом редакторе:

- **macOS**: Preview (Просмотр) — наведите курсор,
  координаты видны в нижней панели
- **GIMP**: наведите курсор — координаты в левом нижнем углу
- **Любой онлайн-редактор**: pixlr.com, photopea.com

Запишите координаты прямоугольника вокруг кормушки:
- (X, Y) — левый верхний угол
- Ширина и высота области

### Шаг 3. Использовать скриншот для интерактивного выбора

Если GUI доступен, можно открыть скриншот в скрипте:

```bash
python detector/select_roi.py --image frame.jpg
```

Это откроет окно с изображением, где можно нарисовать ROI мышкой.

## Способ 3: Ручной ввод в конфиг

Если координаты уже известны, просто впишите в конфиг:

**config.macos.env** (или config.pi.env / config.env):

```env
# === ROI (Region of Interest) - область кормушки ===
ROI_ENABLED=true
ROI_X=200
ROI_Y=100
ROI_WIDTH=640
ROI_HEIGHT=400
```

### Пример расчёта координат

Допустим, камера снимает в 1920x1080 и кормушка расположена
примерно в центре-справа кадра:

```
Разрешение: 1920 x 1080

Кормушка:
  Левый верхний угол: (800, 200)
  Правый нижний угол: (1500, 700)

ROI_X = 800
ROI_Y = 200
ROI_WIDTH  = 1500 - 800 = 700
ROI_HEIGHT = 700 - 200  = 500
```

## Проверка ROI

После настройки ROI перезапустите детектор:

```bash
./run-native.sh
```

В логах должно появиться:

```
INFO - ROI ENABLED: 700x500 at (800, 200)
INFO - Motion detection and video crop will use ROI area only
```

Если ROI задан неправильно (выходит за границы кадра
или слишком маленький), детектор выведет предупреждение.

## Отключение ROI

Чтобы вернуться к детекции на весь кадр:

```env
ROI_ENABLED=false
```

Координаты можно не удалять — они будут проигнорированы.

## FAQ

**Q: ROI работает с RTMP и USB режимом?**
A: Да, ROI применяется к любому источнику видео.

**Q: Что если птица влетает в кадр за пределами ROI?**
A: Движение за пределами ROI полностью игнорируется.
Если птицы подлетают к кормушке с разных сторон,
сделайте ROI немного больше самой кормушки.

**Q: Можно задать несколько ROI?**
A: Нет, поддерживается только один прямоугольный ROI.
Это запланировано как будущее улучшение.

**Q: Координаты зависят от разрешения?**
A: Да. Если вы измените разрешение камеры
(например, с 1080p на 720p), нужно заново определить ROI.
